name: Trigger Promote Overlay

on:
  push:
    branches:
      - master
    paths:
      - kubernetes/app/dev/**

permissions:
  contents: write
  pull-requests: write

jobs:
  trigger-promotion:
    uses: ./.github/workflows/promote-overlay-template.yml
    with:
      source_path: kubernetes/app/dev
      destination_path: kubernetes/app/int
      branch_name: promotion/dev-to-int
      base_branch: master
      commit_message: "Promote changes from dev to int overlay"
      pr_title: "[Promotion] Dev to Int Overlay"
      pr_body: |
        This PR promotes changes from the dev overlay to the int overlay.
        Preserved fields remain intact.
      sync_script: |
        rsync -av --delete kubernetes/app/dev/ kubernetes/app/int/ --exclude 'preserve-*.yml'

        base_dir="kubernetes/app/int"
      
        find "$base_dir" -type f -name "*.yml" ! -name "preserve-*.yml" | while read -r file; do
          filename=$(basename "$file")
          preserve_file="$base_dir/preserve-$filename"
        
          if [[ -f "$preserve_file" ]]; then
            echo "Processing file: $filename with preserve file: $preserve_file"
            yq eval-all 'select(fileIndex == 1) * select(fileIndex == 0)' \
              "$preserve_file" \
              "$file" > "$file.updated"
            mv "$file.updated" "$file"
          else
            echo "Skipping $filename (no corresponding preserve file found)"
          fi
        done
    secrets: inherit
